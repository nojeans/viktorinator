# Code Review: Викторинатор (v0.12)

## Общее впечатление

Проект — образовательное квиз-приложение для QA-инженеров. Архитектура простая и понятная: статический фронтенд (HTML/CSS/JS) + PHP-бэкенд + JSON-файл с вопросами. Есть CI/CD через GitHub Actions и API-тесты через Postman/Newman. Для учебного проекта — хорошая структура.

---

## 1. БАГИ И КРИТИЧЕСКИЕ ПРОБЛЕМЫ

### 1.1 Модалка настроек не открывается (CSS/JS конфликт)

**Файлы:** `style.css:114`, `index.html:50`, `index.html:136-137`

В CSS overlay по умолчанию скрыт через `display: none`:
```css
.settings-overlay {
    display: none;    /* строка 114 */
}
```

Для показа в CSS заготовлен класс `.open`:
```css
.settings-overlay.open {
    display: flex;    /* строка 121-123 */
}
```

Но JavaScript **не использует класс `.open`** — вместо этого управляет атрибутом `hidden`:
```javascript
settingsOverlay.hidden = false;   // строка 137
```

Когда `hidden` снимается, элемент возвращается к CSS-стилям, где `display: none`. Класс `.open` никогда не добавляется. Результат: модалка не должна открываться.

**Решение:** либо использовать `classList.toggle('open')` в JS, либо убрать `display: none` из CSS `.settings-overlay` и полагаться на атрибут `hidden`.

---

### 1.2 Таймер не сбрасывается при повторном нажатии «Вращайте барабан»

**Файл:** `index.html:179-194`

```javascript
const i = setInterval(() => { ... }, 1000);
```

Переменная `i` — локальная. Если пользователь нажмёт «Вращайте барабан» повторно, пока старый таймер ещё работает, старый `setInterval` не будет очищен. Два (и более) таймера будут работать параллельно, вызывая гонку обновления DOM.

**Решение:** сохранять ID интервала в переменную уровня модуля и вызывать `clearInterval()` перед запуском нового.

---

### 1.3 Отсутствует обработка сетевых ошибок

**Файл:** `index.html:167-195`

```javascript
fetch('get_question.php' + location.search)
    .then(r => r.json())
    .then(data => { ... });
// .catch() — отсутствует
```

Если сервер недоступен, пользователь не увидит никакой обратной связи. Также при невалидном JSON `r.json()` выбросит исключение, которое уйдёт в необработанный promise rejection.

---

### 1.4 Непоследовательное поведение UX при закрытии модалки

**Файл:** `index.html:144-158`

- **Кнопка «Отмена»** — закрывает без применения (правильно для «отмены»)
- **Клик по оверлею** — вызывает `applySelectedCategories()` и закрывает

Обычно клик по затемнению — это аналог «отмены». Текущее поведение может быть неинтуитивным: пользователь случайно кликнет мимо модалки и применит нежелательные изменения.

---

## 2. БЕЗОПАСНОСТЬ

### 2.1 Хорошее: XSS-защита ответов

**Файл:** `index.html:108-113`

Функция `escapeHtml()` корректно экранирует `&`, `<`, `>` перед вставкой через `innerHTML`. Для данного контекста этого достаточно.

### 2.2 Хорошее: безопасная обработка categories

**Файл:** `get_question.php:23`

```php
$allowedCategories = array_map('intval', explode(',', $_GET['categories']));
```

`intval` обеспечивает приведение к числу, исключая инъекцию произвольных строк.

### 2.3 Замечание: нет валидации HTTP-метода

**Файл:** `get_question.php`

Эндпоинт принимает любой HTTP-метод (POST, PUT, DELETE). Стоит ограничить до GET:
```php
if ($_SERVER['REQUEST_METHOD'] !== 'GET') {
    http_response_code(405);
    exit;
}
```

### 2.4 Замечание: SSH без верификации хоста в CI

**Файл:** `deploy.yml:57-58`

```yaml
-o StrictHostKeyChecking=no
-o UserKnownHostsFile=/dev/null
```

Это стандартная практика для CI, но снижает защиту от MITM-атак. Лучше добавить fingerprint хоста в `known_hosts`.

---

## 3. ФРОНТЕНД (index.html + style.css)

### 3.1 Inline-стиль вместо CSS-класса

**Файл:** `index.html:84`

```html
<button id="showAnswerBtn" style="display:none;">Показать ответ</button>
```

А также в JS:
```javascript
showAnswerBtn.style.display = 'none';
showAnswerBtn.style.display = 'inline-block';
```

Лучше управлять видимостью через CSS-класс (`.hidden { display: none }`).

### 3.2 Нет `<meta description>` и favicon

Отсутствуют:
- `<meta name="description" content="...">`
- `<link rel="icon" ...>`

Приведёт к 404 на favicon в консоли браузера и пустое описание при шаринге ссылки.

### 3.3 JavaScript в конце `<body>` — ОК

Скрипт расположен перед `</body>`, что гарантирует загрузку DOM. Для такого размера проекта это нормальный подход.

### 3.4 Вся логика в одном файле

Для проекта такого масштаба (~100 строк JS) — допустимо. Если проект будет расти, стоит вынести JS в отдельный файл.

---

## 4. БЭКЕНД (get_question.php)

### 4.1 Чтение файла при каждом запросе

**Файл:** `get_question.php:6`

```php
$data = json_decode(file_get_contents('questions.json'), true);
```

Файл читается с диска при каждом HTTP-запросе. Для 1049 строк JSON это не проблема, но при масштабировании можно добавить APCu-кэширование.

### 4.2 Хорошая валидация структуры

Проверяются наличие ключей `categories`, `id_category`, `title`, `questions`, `question`, `answer`. Битые записи пропускаются (`continue`). Это правильный подход.

### 4.3 Нет HTTP-кода при ошибке

```php
echo json_encode(['error' => 'Нет вопросов по выбранным категориям'], ...);
exit;
```

Возвращается `200 OK` даже при ошибке. Стоит добавить `http_response_code(400)` или `404` для ошибочных случаев.

### 4.4 Относительный путь к JSON-файлу

```php
file_get_contents('questions.json')
```

Зависит от `cwd` PHP-процесса. Если конфигурация сервера изменится, путь может сломаться. Надёжнее использовать `__DIR__ . '/questions.json'`.

---

## 5. ДАННЫЕ (questions.json)

### 5.1 Непоследовательное форматирование

- Категории 1-2 используют 8-пробельный отступ
- Категории 9-11 используют 6-пробельный отступ с другой структурой отступов
- Между некоторыми категориями есть лишние пустые строки и запятые на отдельных строках

**Рекомендация:** прогнать через `json_pp` или `prettier` для единообразия.

### 5.2 Некоторые вопросы не соответствуют категории

- Категория 1 «Клиент-серверная архитектура, HTTP» содержит вопросы о тестировании в целом («Что такое тестирование?», «Принципы тестирования»). Эти вопросы лучше вынести в отдельную вводную категорию.

### 5.3 Структура данных хорошая

JSON-схема логична: `categories[] → questions[] → { question, answer[] }`. Массив ответов позволяет выводить несколько пунктов. `id_category` совпадает с порядковым номером.

---

## 6. CI/CD (deploy.yml)

### 6.1 API-тесты не блокируют деплой

**Файл:** `deploy.yml:81`

```yaml
continue-on-error: true
```

Тесты Newman выполняются, но их провал не останавливает пайплайн. В текущем виде это скорее наблюдательный мониторинг, а не гейт качества.

### 6.2 Тесты запускаются ПОСЛЕ деплоя

Порядок шагов: деплой → тесты. Это значит, что потенциально битый код попадает на сервер до проверки. Лучше тестировать до деплоя (на предыдущем окружении) или добавить smoke-тесты после деплоя, блокирующие rollback.

### 6.3 Нет rollback-механизма

Если деплой испортил рабочую версию, нет автоматического отката. rsync в safe-mode (без `--delete`) снижает риск, но не устраняет его.

### 6.4 Деплой на dev и prod из одной ветки

`workflow_dispatch` позволяет деплоить любой коммит на prod. Нет защиты от случайного деплоя неготового кода на продакшн.

---

## 7. ТЕСТЫ (postman/collection.json)

### 7.1 Минимальное покрытие

Текущие проверки:
- ✅ Status code 200
- ✅ Body содержит «category»
- ✅ Body содержит «question»
- ✅ Body содержит «answer»

Что стоит добавить:
- Проверка JSON-структуры (`pm.response.json()`)
- Проверка типов полей (category — string, question — string, answer — array)
- Тест с фильтрацией по категориям (`?categories=1`)
- Тест с невалидными категориями (`?categories=999`)
- Тест на пустой ответ при несуществующих категориях

### 7.2 Хардкод URL

```json
"raw": "https://quiz.qalibr.ru/get_question.php"
```

URL зашит напрямую. Лучше вынести в переменную окружения Postman (`{{host}}/get_question.php`), чтобы можно было тестировать на dev.

---

## 8. ОБЩИЕ РЕКОМЕНДАЦИИ

| # | Рекомендация | Приоритет |
|---|-------------|-----------|
| 1 | Исправить баг с отображением модалки (CSS/JS конфликт) | Высокий |
| 2 | Добавить `clearInterval` при повторном нажатии «Вращайте барабан» | Высокий |
| 3 | Добавить `.catch()` на `fetch()` с сообщением пользователю | Средний |
| 4 | Использовать `__DIR__` в PHP для пути к JSON | Средний |
| 5 | Возвращать корректные HTTP-коды при ошибках в PHP | Средний |
| 6 | Расширить API-тесты (JSON-структура, фильтрация, edge cases) | Средний |
| 7 | Использовать переменные окружения в Postman-коллекции | Низкий |
| 8 | Добавить favicon | Низкий |
| 9 | Унифицировать форматирование questions.json | Низкий |
| 10 | Добавить валидацию HTTP-метода в PHP | Низкий |

---

## 9. ИТОГО

**Что сделано хорошо:**
- Чистая, понятная архитектура
- XSS-защита на фронтенде
- Валидация входных данных в PHP (`intval`, проверка структуры JSON)
- CI/CD с автоматическим деплоем и тестами
- Адаптивная вёрстка с поддержкой Telegram WebApp
- Хорошая организация вопросов по категориям с фильтрацией

**Что требует внимания:**
- Баг с модалкой (CSS `display:none` конфликтует с JS `hidden`)
- Гонка таймеров при повторном нажатии
- Отсутствие обработки сетевых ошибок
- API-тесты не гейтят деплой
- Минимальное тестовое покрытие
