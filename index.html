<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Викторинатор</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Кнопка настроек -->
<button id="settingsBtn" class="settings-btn" title="Настройки категорий">⚙️</button>

<!-- Затемнение + попап -->
<div id="settingsOverlay" class="settings-overlay">
    <div class="settings-modal">
        <h2>Выбор категорий</h2>

        <div class="category-list">
            <label class="category-item"><input type="checkbox" value="1" checked> 1. Клиент-серверная архитектура, HTTP</label>
            <label class="category-item"><input type="checkbox" value="2" checked> 2. REST, JSON, SOAP, Devtools</label>
            <label class="category-item"><input type="checkbox" value="3" checked> 3. API и микросервисы</label>
            <label class="category-item"><input type="checkbox" value="4" checked> 4. Виды тестирования и тест-дизайн</label>
            <label class="category-item"><input type="checkbox" value="5" checked> 5. Чек-лист и тест-план</label>
            <label class="category-item"><input type="checkbox" value="6" checked> 6. Баг-репорт и тест-кейсы</label>
            <label class="category-item"><input type="checkbox" value="7" checked> 7. SQL и Agile</label>
            <label class="category-item"><input type="checkbox" value="8" checked> 8. HTML, CSS, Charles, TCP/IP</label>
        </div>

        <div class="settings-actions">
            <button id="applyCategories">Применить</button>
            <button id="closeModal">Отмена</button>
        </div>
    </div>
</div>

<div class="container">
    <h1>Викторинатор</h1>

    <button id="spinBtn">Вращайте барабан</button>

    <div id="timer"></div>
    <div id="category"></div>
    <div id="question"></div>

    <button id="showAnswerBtn" style="display:none;">Показать ответ</button>
    <div id="answer"></div>
</div>

<div class="site-version">Версия 0.7</div>

<script>
const spinBtn = document.getElementById('spinBtn');
const timerEl = document.getElementById('timer');
const categoryEl = document.getElementById('category');
const questionEl = document.getElementById('question');
const showAnswerBtn = document.getElementById('showAnswerBtn');
const answerEl = document.getElementById('answer');

const settingsBtn = document.getElementById('settingsBtn');
const settingsOverlay = document.getElementById('settingsOverlay');
const applyBtn = document.getElementById('applyCategories');
const closeBtn = document.getElementById('closeModal');

let currentData = null;

function escapeHtml(text) {
    return text.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}

function getCategoriesFromQuery() {
    const p = new URLSearchParams(window.location.search);
    const c = p.get('categories');
    return c ? c.split(',') : [];
}

function updateQuery(categories) {
    const p = new URLSearchParams(window.location.search);
    categories.length ? p.set('categories', categories.join(',')) : p.delete('categories');
    history.replaceState({}, '', location.pathname + (p.toString() ? '?' + p : ''));
}

/* ===== НАСТРОЙКИ ===== */
settingsBtn.onclick = () => {
    settingsOverlay.style.display = 'flex';
    const selected = getCategoriesFromQuery();
    document.querySelectorAll('.category-item input').forEach(cb => {
        cb.checked = selected.length === 0 || selected.includes(cb.value);
    });
};

closeBtn.onclick = () => settingsOverlay.style.display = 'none';

applyBtn.onclick = () => {
    const selected = [...document.querySelectorAll('.category-item input:checked')].map(cb => cb.value);
    updateQuery(selected);
    settingsOverlay.style.display = 'none';
};

/* ===== ВИКТОРИНА ===== */
spinBtn.onclick = () => {
    categoryEl.textContent = '';
    questionEl.textContent = '';
    answerEl.textContent = '';
    showAnswerBtn.style.display = 'none';

    const url = 'get_question.php' + location.search;

    fetch(url)
        .then(r => r.json())
        .then(data => {
            if (data.error) return categoryEl.textContent = data.error;

            currentData = data;
            let t = 3;
            timerEl.textContent = t;

            const i = setInterval(() => {
                if (--t > 0) timerEl.textContent = t;
                else {
                    clearInterval(i);
                    timerEl.textContent = '';
                    categoryEl.textContent = 'Категория: ' + data.category;
                    questionEl.textContent = data.question;
                    showAnswerBtn.style.display = 'inline-block';
                    showAnswerBtn.onclick = () => {
                        answerEl.innerHTML = data.answer.map(a => '• ' + escapeHtml(a)).join('<br>');
                    };
                }
            }, 1000);
        });
};
</script>

<!-- Метрика — без изменений -->
</body>
</html>
