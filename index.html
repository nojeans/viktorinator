<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- Кодировка UTF-8, чтобы корректно отображался русский текст -->
    <meta charset="UTF-8">

    <!-- Адаптивность: корректное отображение на мобильных устройствах -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Заголовок страницы (вкладка браузера) -->
    <title>Викторинатор</title>

    <!-- Подключение CSS-стилей -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- Основной контейнер приложения -->
<div class="container">
    <h1>Викторинатор</h1>

    <!-- Кнопка запуска викторины -->
    <button id="spinBtn">Вращайте барабан</button>

    <!-- Таймер обратного отсчёта -->
    <div id="timer"></div>

    <!-- Блок для отображения категории -->
    <div id="category"></div>

    <!-- Блок для отображения вопроса -->
    <div id="question"></div>

    <!-- Кнопка показа ответа (по умолчанию скрыта) -->
    <button id="showAnswerBtn" style="display:none;">Показать ответ</button>

    <!-- Блок для отображения ответа -->
    <div id="answer"></div>
</div>

<!-- Версия сайта (служебная информация) -->
<div class="site-version">
    Версия 0.6
</div>

<script>
/*
    Получаем ссылки на HTML-элементы,
    чтобы потом управлять ими из JavaScript
*/
const spinBtn = document.getElementById('spinBtn');
const timerEl = document.getElementById('timer');
const categoryEl = document.getElementById('category');
const questionEl = document.getElementById('question');
const showAnswerBtn = document.getElementById('showAnswerBtn');
const answerEl = document.getElementById('answer');

/*
    Здесь будем хранить текущий вопрос,
    полученный с сервера
*/
let currentData = null;

/*
    Функция экранирования HTML.
    Нужна, чтобы такие строки как "<div>" или "<img>"
    отображались как текст, а не ломали страницу.

    Также защищает от XSS-уязвимостей.
*/
function escapeHtml(text) {
    return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
}

/*
    Основное событие: пользователь нажал кнопку
    "Вращайте барабан"
*/
spinBtn.addEventListener('click', () => {

    // Очищаем предыдущие данные
    categoryEl.textContent = '';
    questionEl.textContent = '';
    answerEl.textContent = '';
    showAnswerBtn.style.display = 'none';
    currentData = null;

    /*
        Запрашиваем новый вопрос с сервера.
        get_question.php возвращает JSON
        со случайной категорией и вопросом.
    */
    fetch('get_question.php')
        .then(response => response.json())
        .then(data => {

            // Если сервер вернул ошибку — показываем её
            if (data.error) {
                categoryEl.textContent = 'Ошибка: ' + data.error;
                return;
            }

            // Сохраняем полученные данные
            currentData = data;

            // Удобный вывод в консоль для отладки
            console.log("Получен вопрос:\n" + JSON.stringify(data, null, 2));

            /*
                Запускаем обратный отсчёт перед показом вопроса.
                Это имитация "вращения барабана".
            */
            let time = 3;
            timerEl.textContent = time;

            const countdown = setInterval(() => {
                time--;

                if (time > 0) {
                    timerEl.textContent = time;
                } else {
                    clearInterval(countdown);
                    timerEl.textContent = '';

                    // Показываем категорию и вопрос
                    categoryEl.textContent = 'Категория: ' + currentData.category;
                    questionEl.textContent = currentData.question;

                    // Показываем кнопку "Показать ответ"
                    showAnswerBtn.style.display = 'inline-block';

                    /*
                        По нажатию на кнопку показываем ответ.
                        Ответ может быть:
                        - массивом строк
                        - одной строкой
                    */
                    showAnswerBtn.onclick = () => {
                        if (Array.isArray(currentData.answer)) {
                            answerEl.innerHTML = currentData.answer
                                .map(a => '• ' + escapeHtml(a))
                                .join('<br>');
                        } else {
                            answerEl.textContent = currentData.answer;
                        }
                    };
                }
            }, 1000);
        })
        .catch(err => {
            // Ошибка сети или сервера
            categoryEl.textContent = 'Ошибка запроса: ' + err;
        });
});
</script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {
            if (document.scripts[j].src === r) { return; }
        }
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],
        k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=105927136', 'ym');

    ym(105927136, 'init', {
        ssr:true,
        webvisor:true,
        clickmap:true,
        accurateTrackBounce:true,
        trackLinks:true
    });
</script>

<noscript>
    <div>
        <img src="https://mc.yandex.ru/watch/105927136"
             style="position:absolute; left:-9999px;" alt="" />
    </div>
</noscript>
<!-- /Yandex.Metrika counter -->

</body>
</html>
