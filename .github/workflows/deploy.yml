name: Manual Deploy (Dev / Prod)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Куда деплоим?"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------- API TESTS (NEWMAN) ----------
      - name: Install Newman
        run: npm install -g newman

      - name: Run API tests (Postman / Newman) with Fixes
        uses: nick-fields/retry@v3
        with:
          max_attempts: 3
          timeout_minutes: 2
          command: >
            newman run postman/collection.json 
            --reporters cli 
            --timeout-request 10000 
            --insecure 
            --header "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"

      # ---------- SSH ----------
      - name: Prepare SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      # ---------- DEPLOY PATH ----------
      - name: Select deploy path
        run: |
          if [ "${{ github.event.inputs.target }}" = "prod" ]; then
            echo "DEPLOY_PATH=${{ secrets.PROD_PATH }}" >> $GITHUB_ENV
          else
            echo "DEPLOY_PATH=${{ secrets.DEV_PATH }}" >> $GITHUB_ENV
          fi

      - name: Debug deploy path
        run: |
          if [ -z "$DEPLOY_PATH" ]; then
            echo "DEPLOY_PATH is EMPTY"
            exit 1
          fi
          echo "Deploying to: $DEPLOY_PATH"

      # ---------- SSH TEST (RETRY x6) ----------
      - name: Test SSH connection (retry)
        run: |
          for i in 1 2 3 4 5 6; do
            echo "SSH attempt $i..."
            ssh \
              -i ~/.ssh/id_ed25519 \
              -p "${{ secrets.SSH_PORT }}" \
              -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=/dev/null \
              -o ConnectTimeout=15 \
              -o ServerAliveInterval=5 \
              -o ServerAliveCountMax=3 \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
              "echo 'SSH OK: $(hostname)'" && break

            echo "SSH failed, retry in 5s..."
            sleep 5

            if [ "$i" -eq 6 ]; then
              echo "SSH failed after 6 attempts"
              exit 1
            fi
          done

      # ---------- DEPLOY (RETRY x6, SAFE MODE) ----------
      - name: Deploy files (safe mode, retry, no delete)
        run: |
          for i in 1 2 3 4 5 6; do
            echo "Deploy attempt $i..."

            rsync -avz \
              --exclude=".git/" \
              --exclude=".github/" \
              --exclude="node_modules/" \
              --exclude=".env" \
              -e "ssh -i ~/.ssh/id_ed25519 -p ${{ secrets.SSH_PORT }} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
              ./ \
              ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:$DEPLOY_PATH && break

            echo "Deploy failed, retry in 5s..."
            sleep 5

            if [ "$i" -eq 6 ]; then
              echo "Deploy failed after 6 attempts"
              exit 1
            fi
          done
